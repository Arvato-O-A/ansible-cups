# CUPS CONFIG
# {{ ansible_managed }}

#
# Configuration file for the CUPS scheduler.  See "man cupsd.conf" for a
# complete description of this file.
# More info at https://www.cups.org/documentation.php/doc-2.1/man-cupsd.conf.html
#


############# LOGGING #############
LogLevel warn
AccessLogLevel config
MaxLogSize 0
PageLogFormat


############# CUPS SERVER INFO #############
ServerName {{ ansible_fqdn }}
ServerAlias {{ ansible_hostname }}
ServerAlias {{ ansible_fqdn }}
ServerAlias {{ ansible_default_ipv4.address }}
ServerAdmin {{ cups_sysadmins_email }}
DefaultPolicy default


############# NETWORK SETTINGS #############
Port 631
Listen /var/run/cups/cups.sock
KeepAlive Yes


############# SECURITY SETTINGS #############
DefaultAuthType Basic


############# PRINTER SETTINGS #############
ImplicitClasses On


############# PRINT JOB SETTINGS #############
PreserveJobHistory {{ cups_cupsd_preserve_job_history }}
PreserveJobFiles {{ cups_cupsd_preserve_job_files }}
AutoPurgeJobs {{ cups_cupsd_auto_purge_jobs }}

{% if cups_cupsd_limit_request_body is defined %}
  LimitRequestBody {{ cups_cupsd_limit_request_body }}
{% endif %}


############# PRINTER SHARING SETTINGS #############
BrowseLocalProtocols {{ cups_browsed_browse_local_protocols }}
{% if ( (cups_browsed_browse_remote_protocols != "none")
	or (cups_browsed_browse_protocols != "none") )%}
	Browsing On
{% else %}
    Browsing Off
{% endif %}



############# LOCATION SETTINGS #############
<Location />
  # Restrict access to the server...
  Encryption Required
  Order deny,allow
  Allow from All
</Location>

<Location /admin>
  # Restrict access to the admin pages...
  AuthType Default
  Encryption Required
  {% if cups_cupsd_require_user_to_be_part_of_to_access_admin_pages is defined %}
    Require user {{ cups_cupsd_require_user_to_be_part_of_to_access_admin_pages }}
  {% endif %}
  Order allow,deny
  Allow from {{ cups_cupsd_admin_subnet }}
  Allow localhost
</Location>

<Location /admin/conf>
  # Restrict access to the configuration files...
  AuthType Default
  Encryption Required
  {% if cups_cupsd_require_user_to_be_part_of_to_access_admin_pages is defined %}
    Require user {{ cups_cupsd_require_user_to_be_part_of_to_access_admin_pages }}
  {% endif %}
  Order allow,deny
  Allow from {{ cups_cupsd_admin_subnet }}
  Allow localhost
</Location>

<Location /jobs>
  # Restrict access to jobs...
  AuthType Default
  Encryption Required
  {% if cups_cupsd_require_user_to_be_part_of_to_access_admin_pages is defined %}
    Require user {{ cups_cupsd_require_user_to_be_part_of_to_access_admin_pages }}
  {% endif %}
  Order allow,deny
  Allow from {{ cups_cupsd_admin_subnet }}
  Allow localhost
</Location>


############# POLICY SETTINGS #############

# Set the default printer/job policies...
<Policy default>
  # Job/subscription privacy...
  JobPrivateAccess default
  JobPrivateValues default
  SubscriptionPrivateAccess default
  SubscriptionPrivateValues default

  # Job-related operations must be done by the owner or an administrator...
  # Send-Document and Send-URI is opened up as IPP needs it depending on printer.
  <Limit Create-Job Print-Job Print-URI Validate-Job Send-Document Send-URI>
    Order deny,allow
  </Limit>

  <Limit Hold-Job Release-Job Restart-Job Purge-Jobs Set-Job-Attributes Create-Job-Subscription Renew-Subscription Cancel-Subscription Get-Notifications Reprocess-Job Cancel-Current-Job Suspend-Current-Job Resume-Job Cancel-My-Jobs Close-Job CUPS-Get-Document>
    AuthType Default
    Require user @OWNER @SYSTEM
    Order deny,allow
  </Limit>

  # All administration operations require an administrator to authenticate...
  <Limit CUPS-Add-Modify-Printer CUPS-Delete-Printer CUPS-Add-Modify-Class CUPS-Move-Job CUPS-Delete-Class CUPS-Set-Default CUPS-Get-Devices>
    AuthType Default
    Require user @SYSTEM
    Order deny,allow
  </Limit>

  # All printer operations require a printer operator to authenticate...
  <Limit Pause-Printer Resume-Printer Enable-Printer Disable-Printer Pause-Printer-After-Current-Job Hold-New-Jobs Release-Held-New-Jobs Deactivate-Printer Activate-Printer Restart-Printer Shutdown-Printer Startup-Printer Promote-Job Schedule-Job-After Cancel-Jobs CUPS-Accept-Jobs CUPS-Reject-Jobs>
    AuthType Default
    Require user @SYSTEM
    Order deny,allow
  </Limit>

  # Only the owner or an administrator can cancel or authenticate a job...
  <Limit Cancel-Job CUPS-Authenticate-Job>
    AuthType Default
    Require user @OWNER @SYSTEM
   Order deny,allow
  </Limit>

  <Limit All>
    Order deny,allow
  </Limit>
</Policy>

{% if cups_cupsd_conf_extra_policies is defined %}
  {{ cups_cupsd_extra_policies }}
{% endif %}